machine:
  hosts:
    wp-rets-client.github.com: 192.30.253.112
    wp-property-tests.github.com: 192.30.253.112
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
    - "~/utils"
    - "~/backups"

  pre:
    - mkdir -p ~/utils ~/docker ~/backups

    - sudo rm -rf /home/ubuntu/wp-property-tests
    - git clone git@192.30.253.112:wp-property/wp-property-tests.git /home/ubuntu/wp-property-tests --branch=master


    - mysql -u ubuntu circle_test < /home/ubuntu/wp-property-tests/state/db-setup.sql
    - mysql -u ubuntu -e "GRANT USAGE on circle_test.* to wp@'%' IDENTIFIED BY 'kjmnlxjvipbxmtud'";
    - mysql -u ubuntu -e "GRANT ALL PRIVILEGES on circle_test.* to wp@'%';";
    - mysql -u ubuntu -e "FLUSH PRIVILEGES;";
    - cat ~/wp-property-tests/static/alias.sh >> ~/.bashrc
    - curl --silent https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar > /home/ubuntu/utils/wp-cli
    - chmod +x /home/ubuntu/utils/wp-cli;
    - if [[ -e ~/docker/wp.tar ]]; then docker load -i ~/docker/wp.tar; else docker pull wordpress && docker save wordpress > ~/docker/wp.tar; fi
    - export CONTAINER_HOSTNAME=${CIRCLE_SHA1}-${CIRCLE_BUILD_NUM}.ngrok.io

  override:
    - "bash /home/ubuntu/wp-property-tests/bin/run-container.sh"
    - "sudo chown -R ubuntu /home/ubuntu/wp-property-tests"
    - "sudo chown -R ubuntu /home/ubuntu/wp-property"

test:
  pre:
    - curl -H 'host:localhost' http://localhost:3000/
    - /home/ubuntu/wp-property-tests/bin/wp --path=/home/ubuntu/www --url=localhost:3000 user create andy@udx.io andy@udx.io --role=administrator --user_pass=jgnqaobleiubnmcx
    - /home/ubuntu/wp-property-tests/bin/wp --path=/home/ubuntu/www --url=localhost:3000 option update home "http://${CIRCLE_SHA1}-${CIRCLE_BUILD_NUM}.ngrok.io"
    - /home/ubuntu/wp-property-tests/bin/wp --path=/home/ubuntu/www --url=localhost:3000 option update siteurl "http://${CIRCLE_SHA1}-${CIRCLE_BUILD_NUM}.ngrok.io"

  override:
    - /home/ubuntu/wp-property-tests/bin/wp --path=/home/ubuntu/www --url=localhost:3000 plugin activate wp-property
    - curl -H 'host:localhost' http://localhost:3000/

  post:
    - echo "Tests finished.";
    #- grunt testcodeclimate
    
