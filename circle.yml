machine:
  hosts:
    wp-rets-client.github.com: 192.30.253.112
    wp-property-tests.github.com: 192.30.253.112
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
    - "~/utils"
    - "~/backups"

  pre:
    - mkdir -p ~/utils ~/docker ~/backups

    - sudo rm -rf /home/ubuntu/wp-property-tests
    - git clone git@192.30.253.112:wp-property/wp-property-tests.git /home/ubuntu/wp-property-tests --branch=master

    - "bash /home/ubuntu/wp-property-tests/bin/create-sql.sh"
    - "bash /home/ubuntu/wp-property-tests/bin/prepare-for-docker.sh"
    - "bash /home/ubuntu/wp-property-tests/bin/run-container.sh"
    - "bash /home/ubuntu/wp-property-tests/bin/fix-permissions.sh"

    - echo "Site at http://${CIRCLE_SHA1}-${CIRCLE_BUILD_NUM}.ngrok.io"

  override:
    - echo "Skipping composer install on purpose."

test:
  pre:
    - curl -H 'host:localhost' http://localhost:3000/ -I
    - /home/ubuntu/wp-property-tests/bin/wp --path=/home/ubuntu/www --url=localhost:3000 user create andy@udx.io andy@udx.io --role=administrator --user_pass=jgnqaobleiubnmcx
    - /home/ubuntu/wp-property-tests/bin/wp --path=/home/ubuntu/www --url=localhost:3000 option update home "http://${CIRCLE_SHA1}-${CIRCLE_BUILD_NUM}.ngrok.io"
    - /home/ubuntu/wp-property-tests/bin/wp --path=/home/ubuntu/www --url=localhost:3000 option update siteurl "http://${CIRCLE_SHA1}-${CIRCLE_BUILD_NUM}.ngrok.io"

  override:
    - /home/ubuntu/wp-property-tests/bin/wp --path=/home/ubuntu/www --url=localhost:3000 plugin activate wp-property
    - curl -H 'host:localhost' http://localhost:3000/ -I
    - curl -H 'host:localhost' http://localhost:3000/?ci-test=one
    - curl -H 'host:localhost' http://localhost:3000/?ci-test=two

  post:
    - echo "Tests finished.";
    #- grunt testcodeclimate
    
